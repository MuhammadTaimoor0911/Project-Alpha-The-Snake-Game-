window.power={lives:0,ghostUntil:0};let powerups=[];let lastPowerSpawn=0;function powerActive(){return performance.now()<window.power.ghostUntil}function addLife(n=1){window.power.lives+=n}function useLife(){if(window.power.lives>0){window.power.lives-=1;return true}return false}function spawnPowerup(){const b=bounds();for(let i=0;i<200;i++){const x=b.minX+Math.floor(Math.random()*(b.maxX-b.minX+1));const y=b.minY+Math.floor(Math.random()*(b.maxY-b.minY+1));const hitSnake=snake.some(s=>s.x===x&&s.y===y);const hitFood=(food&&food.x===x&&food.y===y);const hitObs=(typeof obstacles!=="undefined")&&obstacles.some(o=>o.x===x&&o.y===y);const hitPU=powerups.some(p=>p.x===x&&p.y===y);if(!hitSnake&&!hitFood&&!hitObs&&!hitPU){const types=["life","ghost"];const type=types[Math.floor(Math.random()*types.length)];const ttl=10000+Math.floor(Math.random()*5000);powerups.push({x,y,type,expires:performance.now()+ttl});return}}}function updatePowerups(){const now=performance.now();powerups=powerups.filter(p=>p.expires>now)}function trySpawnPowerup(){const now=performance.now();if(now-lastPowerSpawn>7000){lastPowerSpawn=now;if(Math.random()<0.7)spawnPowerup()}}const _pw_reset=reset;reset=function(){_pw_reset();powerups=[];window.power.lives=0;window.power.ghostUntil=0;lastPowerSpawn=performance.now()};const _pw_spawnFood=spawnFood;spawnFood=function(){do{_pw_spawnFood()}while(powerups.some(p=>p.x===food.x&&p.y===food.y))};const _pw_updateMove=updateMove;updateMove=function(){dir=nextDir;const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};const b=bounds();const hitWall=head.x<b.minX||head.y<b.minY||head.x>b.maxX||head.y>b.maxY;const hitSelf=snake.some(s=>s.x===head.x&&s.y===head.y);if(hitWall||hitSelf){if(useLife()){return}else{state="over";return}}snake.unshift(head);const ate=head.x===food.x&&head.y===food.y;if(ate){score+=1;scoreEl.textContent=score;spawnFood()}else{snake.pop()}for(let i=powerups.length-1;i>=0;i--){const p=powerups[i];if(p.x===head.x&&p.y===head.y){if(p.type==="life"){addLife(1)}else if(p.type==="ghost"){window.power.ghostUntil=performance.now()+12000}powerups.splice(i,1)}}};const _pw_render=render;render=function(){updatePowerups();trySpawnPowerup();_pw_render();for(let i=0;i<powerups.length;i++){const p=powerups[i];ctx.fillStyle=p.type==="life"?"#6cf":"#fc6";ctx.beginPath();ctx.arc(p.x*size+size/2,p.y*size+size/2,6,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.stroke()}if(window.power.lives>0){ctx.fillStyle="#6cf";ctx.font="bold 12px system-ui";ctx.fillText("Lives: "+window.power.lives,8,16)}if(powerActive()){ctx.fillStyle="#fc6";ctx.font="bold 12px system-ui";ctx.fillText("Ghost",70,16)}}
