const canvas=document.getElementById("game");const ctx=canvas.getContext("2d");const scoreEl=document.getElementById("score");const menu=document.getElementById("menu");const startBtn=document.getElementById("startBtn");const size=20;const tiles=canvas.width/size;let snake,dir,nextDir,food,score,state,lastMove,lastFrame,particles,shrink,ambientAcc;function bounds(){const min=shrink;const max=tiles-1-shrink;return{minX:min,minY:min,maxX:max,maxY:max}}function reset(){snake=[{x:Math.floor(tiles/2),y:Math.floor(tiles/2)}];dir={x:1,y:0};nextDir=dir;score=0;state="menu";lastMove=0;lastFrame=0;particles=[];shrink=0;ambientAcc=0;scoreEl.textContent=score;menu.style.display="flex";spawnFood()}function start(){state="playing";menu.style.display="none"}function stepMs(){const base=220;const min=70;const gain=6;const d=Math.min(score*gain,base-min);return base-d}function maxShrink(){return Math.max(0,Math.floor((tiles-6)/2))}function spawnFood(){const b=bounds();while(true){const x=b.minX+Math.floor(Math.random()*(b.maxX-b.minX+1));const y=b.minY+Math.floor(Math.random()*(b.maxY-b.minY+1));const hit=snake.some(s=>s.x===x&&s.y===y);if(!hit){food={x,y};break}}}function setDir(nx,ny){if(state!=="playing")return;const opp=nx===-dir.x&&ny===-dir.y;if(!opp)nextDir={x:nx,y:ny}}function addParticle(px,py,color){const a=(Math.random()*2-1)*Math.PI;const sp=20+Math.random()*40;particles.push({x:px,y:py,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.6,size:2+Math.random()*2,color})}function addDirectionalParticle(px,py,dx,dy,color){const sp=40+Math.random()*60;const jx=(Math.random()*2-1)*10;const jy=(Math.random()*2-1)*10;particles.push({x:px,y:py,vx:dx*sp+jx,vy:dy*sp+jy,life:0.5,size:2,color})}function updateMove(){dir=nextDir;const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};const b=bounds();const hitWall=head.x<b.minX||head.y<b.minY||head.x>b.maxX||head.y>b.maxY;const hitSelf=snake.some(s=>s.x===head.x&&s.y===head.y);if(hitWall||hitSelf){state="over";return}snake.unshift(head);const ate=head.x===food.x&&head.y===food.y;if(ate){score+=1;scoreEl.textContent=score;const cx=head.x*size+size/2;const cy=head.y*size+size/2;for(let i=0;i<14;i++)addParticle(cx,cy,"#e66");spawnFood()}else{snake.pop()}const s=Math.min(Math.floor(score/3),maxShrink());if(s!==shrink){shrink=s}}function updateParticles(dt){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.life-=dt;if(p.life<=0){particles.splice(i,1);continue}p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.98;p.vy*=0.98}}function spawnAmbient(dt){ambientAcc+=dt;if(ambientAcc>0.05){ambientAcc=0;if(Math.random()<0.4){addParticle(Math.random()*canvas.width,Math.random()*canvas.height,"rgba(255,255,255,0.6)")}}}function render(){ctx.fillStyle="#000";ctx.fillRect(0,0,canvas.width,canvas.height);const b=bounds();ctx.strokeStyle="#444";ctx.lineWidth=2;ctx.strokeRect(b.minX*size+1,b.minY*size+1,(b.maxX-b.minX+1)*size-2,(b.maxY-b.minY+1)*size-2);ctx.fillStyle="#e33";ctx.fillRect(food.x*size,food.y*size,size,size);for(let i=snake.length-1;i>=0;i--){const s=snake[i];const hue=i===0?"#3f6":"#2a4";ctx.fillStyle=hue;ctx.fillRect(s.x*size,s.y*size,size,size)}for(let i=0;i<snake.length;i++){const s=snake[i];const cx=s.x*size+size/2;const cy=s.y*size+size/2;const col=i===0?"rgba(60,220,120,0.8)":"rgba(40,180,100,0.5)";addParticle(cx,cy,col)}for(let i=0;i<particles.length;i++){const p=particles[i];ctx.fillStyle=typeof p.color==="string"&&p.color.startsWith("rgba")?p.color:`rgba(${p.color=== "#e66" ? "230,102,102" : "255,255,255"},${Math.max(0,p.life)})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill()}if(state==="over"){ctx.fillStyle="rgba(0,0,0,.6)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#fff";ctx.font="bold 22px system-ui";ctx.textAlign="center";ctx.fillText("Game Over",canvas.width/2,canvas.height/2-10);ctx.font="16px system-ui";ctx.fillText("Press Enter to restart",canvas.width/2,canvas.height/2+18)}}function loop(t){if(!lastFrame)lastFrame=t;const dt=(t-lastFrame)/1000;lastFrame=t;spawnAmbient(dt);updateParticles(dt);if(state==="playing"){if(!lastMove)lastMove=t;const ms=stepMs();if(t-lastMove>=ms){lastMove=t;const hx=snake[0].x*size+size/2;const hy=snake[0].y*size+size/2;addDirectionalParticle(hx,hy,dir.x,dir.y,"rgba(60,220,120,0.9)");updateMove()}}render();requestAnimationFrame(loop)}document.addEventListener("keydown",e=>{if(e.key==="ArrowUp"||e.key==="w")setDir(0,-1);else if(e.key==="ArrowDown"||e.key==="s")setDir(0,1);else if(e.key==="ArrowLeft"||e.key==="a")setDir(-1,0);else if(e.key==="ArrowRight"||e.key==="d")setDir(1,0);else if(e.key==="Enter"){if(state==="menu"){start()}else if(state==="over"){reset();start()}}});startBtn&&startBtn.addEventListener("click",()=>{if(state==="menu"){start()}});reset();requestAnimationFrame(loop);
