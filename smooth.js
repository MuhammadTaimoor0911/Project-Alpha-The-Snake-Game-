let prevSnake=null;let lastObsScore=-1;const _updateMove=updateMove;updateMove=function(){prevSnake=snake.map(s=>({x:s.x,y:s.y}));if(typeof updateShrink==="function")updateShrink();_updateMove()};function lerp(a,b,t){return a+(b-a)*t}const _baseRender=render;render=function(){const ms=(window.stepMs?window.stepMs():stepMs());const now=performance.now();const since=lastMove?now-lastMove:0;const t=Math.max(0,Math.min(1,ms?since/ms:0));if(typeof updateShrink==="function")updateShrink();const b=bounds();if(state==="playing"&&snake.some(s=>s.x<b.minX||s.y<b.minY||s.x>b.maxX||s.y>b.maxY))state="over";if(typeof updatePowerups==="function")updatePowerups();if(typeof trySpawnPowerup==="function")trySpawnPowerup();const diff=(window.getDiffSettings&&window.getDiffSettings())||{obsPerScore:1};if(lastObsScore!==score){for(let i=0;i<(diff.obsPerScore||1);i++)spawnObstacle&&spawnObstacle();lastObsScore=score}ctx.fillStyle="#000";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle="#444";ctx.lineWidth=2;ctx.strokeRect(b.minX*size+1,b.minY*size+1,(b.maxX-b.minX+1)*size-2,(b.maxY-b.minY+1)*size-2);ctx.fillStyle="#e33";ctx.fillRect(food.x*size,food.y*size,size,size);if(typeof obstacles!=="undefined"){ctx.fillStyle="#666";for(let i=0;i<obstacles.length;i++){const o=obstacles[i];if(o.x>=b.minX&&o.y>=b.minY&&o.x<=b.maxX&&o.y<=b.maxY)ctx.fillRect(o.x*size,o.y*size,size,size)}}if(!prevSnake)prevSnake=snake.map(s=>({x:s.x,y:s.y}));for(let i=snake.length-1;i>=0;i--){const c=snake[i];const p=prevSnake[i]||c;const x=lerp(p.x,c.x,t)*size;const y=lerp(p.y,c.y,t)*size;ctx.fillStyle=i===0?"#3f6":"#2a4";ctx.fillRect(x,y,size,size)}for(let i=0;i<snake.length;i++){const s=snake[i];const cx=lerp(prevSnake[i]?.x??s.x,s.x,t)*size+size/2;const cy=lerp(prevSnake[i]?.y??s.y,s.y,t)*size+size/2;const col=i===0?"rgba(60,220,120,0.8)":"rgba(40,180,100,0.5)";addParticle(cx,cy,col)}for(let i=0;i<particles.length;i++){const p=particles[i];ctx.fillStyle=typeof p.color==="string"&&p.color.startsWith("rgba")?p.color:`rgba(${p.color=== "#e66" ? "230,102,102" : "255,255,255"},${Math.max(0,p.life)})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill()}if(typeof powerups!=="undefined"){for(let i=0;i<powerups.length;i++){const pu=powerups[i];ctx.fillStyle=pu.type==="life"?"#6cf":"#fc6";ctx.beginPath();ctx.arc(pu.x*size+size/2,pu.y*size+size/2,6,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.stroke()}if(window.power&&window.power.lives>0){ctx.fillStyle="#6cf";ctx.font="bold 12px system-ui";ctx.fillText("Lives: "+window.power.lives,8,16)}if(window.power&&performance.now()<window.power.ghostUntil){ctx.fillStyle="#fc6";ctx.font="bold 12px system-ui";ctx.fillText("Ghost",70,16)}}if(state==="playing"&&typeof obstacles!=="undefined"){const h=snake[0];const hitObs=obstacles.some(o=>o.x===h.x&&o.y===h.y);if(hitObs){const ghost=window.power&&performance.now()<window.power.ghostUntil;if(!ghost){if(window.power&&window.power.lives>0){window.power.lives-=1}else{state="over"}}}}if(typeof obstacles!=="undefined"&&obstacles.some(o=>o.x===food.x&&o.y===food.y))spawnFood();if(state==="over"){ctx.fillStyle="rgba(0,0,0,.6)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#fff";ctx.font="bold 22px system-ui";ctx.textAlign="center";ctx.fillText("Game Over",canvas.width/2,canvas.height/2-10);ctx.font="16px system-ui";ctx.fillText("Press Enter to restart",canvas.width/2,canvas.height/2+18)}}
